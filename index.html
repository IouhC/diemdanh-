<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Điểm danh hội nghị</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
    }
    h2 {
      color: #007BFF;
    }
    button {
      background: #007BFF;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #msg {
      margin-top: 20px;
      color: #333;
      font-size: 16px;
    }
    #guide {
      margin-top: 25px;
      font-size: 15px;
      color: #555;
      line-height: 1.6;
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h2>📍 Điểm danh Hội nghị</h2>
  <p>Nhấn nút bên dưới để xác nhận vị trí và mở form điểm danh.</p>
  <button id="btn">Điểm danh ngay</button>
  <p id="msg"></p>

  <div id="guide">
    ⚠️ <b>Vui lòng bật định vị (GPS)</b> trước khi nhấn nút.<br><br>
    🔹 <b>Trên điện thoại Android:</b><br>
    - Vào <b>Cài đặt → Vị trí</b> → Bật công tắc “Vị trí”.<br>
    - Khi trình duyệt hỏi “Cho phép trang web truy cập vị trí?”, chọn <b>Cho phép</b>.<br><br>
    🔹 <b>Trên iPhone (iOS):</b><br>
    - Mở <b>Cài đặt → Quyền riêng tư → Dịch vụ định vị → Cho phép Safari </b> → Bật lên.<br>
    - Cuộn xuống chọn trình duyệt bạn đang dùng (Safari hoặc Chrome).<br>
    - Chọn <b>Khi sử dụng ứng dụng</b> hoặc <b>Luôn luôn</b> để cho phép truy cập vị trí.<br><br>
    🔹 <b>Lưu ý:</b> Nếu vẫn không hoạt động, hãy tải lại trang sau khi bật định vị.
  </div>

  <script>
    // ===== CẤU HÌNH =====
    const formBase = "https://docs.google.com/forms/d/e/1FAIpQLSfQjMNXIBELZFHuwOhL_qx6qPJHhMoXxryibR2Sdy26VP7BiA/viewform";
    const EVENT_LAT = 9.91558998519411;  // Tọa độ hội nghị
    const EVENT_LON = 105.14389255746083;
    const ALLOWED_RADIUS = 300; // mét

    function toRad(x) { return x * Math.PI / 180; }
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    const msg = document.getElementById('msg');

    document.getElementById('btn').addEventListener('click', () => {
      msg.textContent = "📡 Đang lấy vị trí của bạn...";

      if (!navigator.geolocation) {
        msg.textContent = "❌ Trình duyệt không hỗ trợ định vị.";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const dist = haversine(EVENT_LAT, EVENT_LON, lat, lon);

          if (dist > ALLOWED_RADIUS) {
            msg.textContent = `⚠️ Bạn đang cách hội nghị ${Math.round(dist)} mét — ngoài khu vực cho phép.`;
            return;
          }

          msg.textContent = `✅ Vị trí hợp lệ (cách ${Math.round(dist)} m). Đang mở form...`;
          window.location.href = formBase;
        },
        (err) => {
          msg.textContent = "❌ Không thể lấy vị trí: " + err.message + ". Vui lòng kiểm tra lại cài đặt định vị.";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  </script>
</body>
</html>
